# `repository.py` (content) 文档

此文件定义了 `CRUDRedditContent` 类，它是一个仓库（Repository），封装了所有与抓取的Reddit内容（帖子和评论）相关的数据库查询和操作。这个类的方法都是静态的，作为一个工具集来使用。

## `CRUDRedditContent` 类

### `get_comments_by_post(db, post_id, limit)`
- **功能**: 获取指定帖子的评论列表。
- **实现**: 
    - 查询 `RedditComment` 表，筛选出 `post_id` 匹配的记录。
    - 按照评论的 `score`（得分）降序排序。
    - 使用 `limit` 限制返回的评论数量。

### `search_comments(db, query, subreddits, min_score, days, limit)`
- **功能**: 在评论中进行关键词搜索，并支持多种过滤条件。
- **实现**: 
    - 动态构建一个查询，基础条件是评论正文 (`body`) 包含 `query` 字符串（不区分大小写），并且得分 (`score`) 大于等于 `min_score`。
    - **可选过滤**: 
        - 如果提供了 `subreddits` 列表，则只在这些子版块中搜索。
        - 如果提供了 `days`，则只搜索最近N天内抓取的数据。
    - 结果同样按 `score` 降序排序并限制数量。

### `get_subreddit_stats(db, subreddit, days)`
- **功能**: 为指定的子版块（subreddit）生成一个统计报告。
- **实现**: 这是一个聚合查询方法，它执行多个独立的数据库查询来收集信息：
    1.  **帖子统计**: 计算指定时间段内帖子的总数、平均得分、最高得分和平均评论数。
    2.  **评论统计**: 计算评论的总数、平均得分和最高得分。
    3.  **热门作者**: 找出在该子版块中最活跃的评论者。通过 `GROUP BY` 作者名，计算每个作者的评论总数和平均得分，并按评论数降序排序，返回前10名。
- **返回值**: 返回一个结构化的字典，包含了以上所有统计信息。

### `delete_old_content(db, days_to_keep)`
- **功能**: 一个数据库维护方法，用于清理旧的内容数据，防止数据库无限膨胀。
- **实现**: 
    1.  根据 `days_to_keep` 计算出一个截止日期 (`cutoff_date`)。
    2.  分两步执行删除操作：
        - 首先，找出并删除所有抓取时间早于 `cutoff_date` 的**评论**。
        - 然后，找出并删除所有抓取时间早于 `cutoff_date` 的**帖子**。（先删除评论可以利用外键的级联删除，但这里分开删除更明确）
    3.  提交数据库事务。
- **返回值**: 返回一个元组，包含了被删除的帖子数量和评论数量。

## 全局实例
- `crud_reddit_content = CRUDRedditContent()`: 创建了一个全局唯一的仓库实例，供上层服务或API路由调用。
